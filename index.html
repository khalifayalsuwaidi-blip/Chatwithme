// ========================
// SETTINGS
// ========================
let currentRoom = "global";
let role = "user"; // user | admin | creator

let bannedUsers = JSON.parse(localStorage.getItem("bannedUsers")) || [];
let mutedUsers = JSON.parse(localStorage.getItem("mutedUsers")) || [];
let adminUsers = JSON.parse(localStorage.getItem("adminUsers")) || [];

// ========================
// SECRET ACCESS LINKS
// ========================
function checkAccess(){
  const params = new URLSearchParams(window.location.search);

  // CREATOR LINK
  if(params.get("access") === "khalifaowner"){
    let password = prompt("Enter Creator Password ðŸ‘‘");
    if(password === "creator123"){
      role = "creator";
      alert("ðŸ‘‘ Creator Mode Activated");
    } else {
      alert("Wrong Password âŒ");
    }
    window.history.replaceState({}, document.title, window.location.pathname);
  }

  // ADMIN LINK
  if(params.get("access") === "khalifaadmin"){
    let password = prompt("Enter Admin Password ðŸ”¥");
    if(password === "admin2"){
      role = "admin";
      alert("ðŸ”¥ Admin Mode Activated");
    } else {
      alert("Wrong Password âŒ");
    }
    window.history.replaceState({}, document.title, window.location.pathname);
  }
}
checkAccess();

// ========================
// BAD WORD FILTER
// ========================
const badWords = [
  "fuck","fucker","fucking",
  "shit","bitch",
  "asshole","dick",
  "pussy","bastard"
];

function filterMessage(text){
  let filtered = text;
  badWords.forEach(word=>{
    const regex = new RegExp("\\b"+word+"\\b","gi");
    filtered = filtered.replace(regex,"****");
  });
  return filtered;
}

// ========================
// ROOMS
// ========================
const rooms = {
  global:[],
  boys:[],
  girls:[]
};

function switchRoom(room){
  currentRoom = room;
  renderMessages();
}

// ========================
// SEND MESSAGE
// ========================
function sendMessage(){

  const username = document.getElementById("username").value || "Guest";
  let message = document.getElementById("messageInput").value.trim();
  if(!message) return;

  // BAN CHECK
  if(bannedUsers.includes(username)){
    alert("You are banned ðŸš«");
    document.getElementById("messageInput").value="";
    return;
  }

  // MUTE CHECK
  if(mutedUsers.includes(username)){
    alert("You are muted ðŸ”‡");
    document.getElementById("messageInput").value="";
    return;
  }

  // ========================
  // COMMANDS
  // ========================
  if(role === "admin" || role === "creator"){

    // BAN
    if(message.startsWith("/ban ")){
      let target = message.split(" ")[1];

      if(role === "admin"){
        if(adminUsers.includes(target)){
          alert("Admins cannot ban other admins âŒ");
          return;
        }
        alert("Admins cannot ban the creator ðŸ‘‘");
        return;
      }

      // Creator can ban anyone except self
      if(target === username){
        alert("You cannot ban yourself ðŸ‘‘");
        return;
      }

      if(!bannedUsers.includes(target)){
        bannedUsers.push(target);
        localStorage.setItem("bannedUsers", JSON.stringify(bannedUsers));
      }

      alert(target + " banned ðŸš«");
      return;
    }

    // MUTE
    if(message.startsWith("/mute ")){
      let target = message.split(" ")[1];

      if(role === "admin"){
        if(adminUsers.includes(target)){
          alert("Admins cannot mute other admins âŒ");
          return;
        }
        alert("Admins cannot mute the creator ðŸ‘‘");
        return;
      }

      if(!mutedUsers.includes(target)){
        mutedUsers.push(target);
        localStorage.setItem("mutedUsers", JSON.stringify(mutedUsers));
      }

      alert(target + " muted ðŸ”‡");
      return;
    }

    // PROMOTE (Creator Only)
    if(role === "creator" && message.startsWith("/promote ")){
      let target = message.split(" ")[1];
      if(!adminUsers.includes(target)){
        adminUsers.push(target);
        localStorage.setItem("adminUsers", JSON.stringify(adminUsers));
        alert(target + " promoted to Admin ðŸ”¥");
      }
      return;
    }

    // CLEAR ROOM
    if(message === "/clear"){
      rooms[currentRoom] = [];
      renderMessages();
      return;
    }
  }

  message = filterMessage(message);

  rooms[currentRoom].push({
    user:username,
    text:message,
    role:role
  });

  document.getElementById("messageInput").value="";
  renderMessages();
}

// ========================
// RENDER
// ========================
function renderMessages(){

  const chatDiv = document.getElementById("chat");
  chatDiv.innerHTML="";

  rooms[currentRoom].forEach(msg=>{
    const div = document.createElement("div");

    if(msg.role === "creator"){
      div.style.color = "white";
      div.style.fontWeight = "bold";
      div.innerText = "ðŸ‘‘ " + msg.user + ": " + msg.text;
    }
    else if(msg.role === "admin"){
      div.style.color = "red";
      div.innerText = "ðŸ”¥ ADMIN " + msg.user + ": " + msg.text;
    }
    else{
      div.innerText = msg.user + ": " + msg.text;
    }

    chatDiv.appendChild(div);
  });

  chatDiv.scrollTop = chatDiv.scrollHeight;
}
